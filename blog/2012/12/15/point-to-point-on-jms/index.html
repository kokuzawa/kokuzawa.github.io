
<!DOCTYPE html>
<html lang="ja-jp">
<head>

  
  <meta charset="UTF-8">
  <title>
    Point-to-Point on JMS | KATSUMI KOKUZAWA&#39;S BLOG
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="https://kokuzawa.github.io/blog/2012/12/15/point-to-point-on-jms/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link href="https://kokuzawa.github.io/index.xml" rel="alternate" type="application/rss+xml" title="KATSUMI KOKUZAWA&#39;S BLOG" />
  <link href="https://kokuzawa.github.io/index.xml" rel="feed" type="application/rss+xml" title="KATSUMI KOKUZAWA&#39;S BLOG" />

  
  

  
  
    <link rel="icon" href="/images/favicon.ico" sizes="32x32">
  

  <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="https://kokuzawa.github.io/">KATSUMI KOKUZAWA&#39;S BLOG</a></h1>
        
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="/tags/"><i class="fas fa-tag fa-2x"></i></a></li>
          <li><a href="https://twitter.com/kokuzawa" target="_blank"><i class="fab fa-twitter fa-2x"></i></a></li>
          
          <li><a href="https://github.com/kokuzawa" target="_blank"><i class="fab fa-github-alt fa-2x"></i></a></li>
          <li><a href="https://kokuzawa.github.io/index.xml" type="application/rss+xml" target="_blank"><i class="fas fa-rss-square fa-2x"></i></a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>Point-to-Point on JMS</h1>
      <div class="meta">
        Dec 15, 2012 &nbsp;
        
          #<a href="/tags/java">Java</a>&nbsp;
        
          #<a href="/tags/javaee">JavaEE</a>&nbsp;
        
          #<a href="/tags/glassfish">GlassFish</a>&nbsp;
        
          #<a href="/tags/jms">JMS</a>&nbsp;
        
      </div>
    </div>
    <article>
      

<p><a href="http://atnd.org/events/33783">JavaEE Advent Calendar 2012</a>の15日目のエントリーです。<br />
昨日は<a href="https://twitter.com/yoshioterada">@yoshioterada</a>さんの<a href="http://yoshio3.com/2012/12/14/javaee7-websocket-client-with-javafx/">Java EE 7 WebSocket Client Sample Application with JavaFX</a>です。<br />
明日は<a href="https://twitter.com/akirakoyasu">@akirakoyasu</a>さんです。</p>

<h2 id="普段は使わないjmsを使う">普段は使わないJMSを使う</h2>

<p>おそらくJMSの本来の利用方法は非同期通信を利用した分散処理なのだと思うけど、今回はそんな高尚な目的ではなく、単純なメッセンジャーとして利用します。
世の中のどの位のプロジェクトでJMSが利用されているのか分からないけど、JavaEEの仕様にJMSが含まれているにも関わらず、今まで本格的に利用した事がありません。
分散処理をするケースがあるプロジェクトに参加した事が無いのか、またはサーバがいつもTomcatだからなのか。
おそらく後者なのだと思うけど、ということはつまり分散処理の必要がないプロジェクトということなんだと思います。</p>

<p>そんな事もあって、JMSの知識が皆無だったわけですが、
JavaEEのアドベンドカレンダーをやるに当たって何か普段は触らないようなことをやりたいなと思い立ち、JMSを使ってみる事にしました。</p>

<h2 id="必要なもの">必要なもの</h2>

<ul>
<li>GlassFish-3.1.2.2</li>
<li>jms-api-1.1-rev-1.jar</li>
</ul>

<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;javax.jms&lt;/groupId&gt;
  &lt;artifactId&gt;jms-api&lt;/artifactId&gt;
  &lt;version&gt;1.1-rev-1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<ul>
<li>imq-4.5.2.jar</li>
</ul>

<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;org.glassfish.mq&lt;/groupId&gt;
  &lt;artifactId&gt;imq&lt;/artifactId&gt;
  &lt;version&gt;4.5.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>JMSを利用する為には、メッセージプロバイダが必要になります。プロバイダにはOpenMQ, MQSeries, SonicMQなどがありますが、
今回は導入が簡単なOpenMQを利用します。OpenMQはGlassFishに付属してインストールされます。インストール時に特に何かを意識する必要はありません。
また、OpenMQにアクセスする為に2つのライブラリが必要になります。jms-apiとimqです。Mavenリポジトリに登録されているので、
こちらも容易に入手可能です。</p>

<h2 id="事前準備">事前準備</h2>

<p>GlassFishを起動しておく必要があります。ポートとして7676を利用するので、GlassFishがローカルではなく、リモート環境にある場合は、
ポートへのアクセスを許可する必要があるかもしれません。</p>

<h2 id="メッセージプロデューサーを作る">メッセージプロデューサーを作る</h2>

<p>メッセージを送信するプロデューサーを作ります。</p>

<pre><code class="language-java">package jp.co.baykraft.jmsexample;

import com.sun.messaging.ConnectionConfiguration;
import com.sun.messaging.QueueConnectionFactory;
import javax.jms.JMSException;
import javax.jms.Queue;
import javax.jms.QueueConnection;
import javax.jms.QueueSender;
import javax.jms.QueueSession;
import javax.jms.TextMessage;

/**
 * メッセージを送信するクラスです。
 * @author Katsumi
 */
public class Sender
{
    public static void main(String... args) throws JMSException
    {
        QueueConnectionFactory factory = new QueueConnectionFactory();
        factory.setProperty(ConnectionConfiguration.imqAddressList, 
            &quot;localhost:7676&quot;);
        QueueConnection connection = factory.createQueueConnection();
        QueueSession session = connection.createQueueSession(false, 
            QueueSession.AUTO_ACKNOWLEDGE);
        Queue queue = session.createQueue(&quot;KQueue&quot;);

        QueueSender sender = session.createSender(queue);
        TextMessage message = session.createTextMessage();
        message.setText(&quot;メッセージ&quot;);
        sender.send(message);

        connection.close();

        System.out.println(&quot;Finished.&quot;);
    }
}
</code></pre>

<p><code>session.createQueue(&quot;KQueue&quot;)</code>でKQueueという文字列を指定していますが、これは任意の文字列です。
メッセージを受信する側でも同じ文字列を指定してメッセージを受け取ります。</p>

<h2 id="メッセージコンシューマを作る">メッセージコンシューマを作る</h2>

<p>次にメッセージを受信するコンシューマを作ります。</p>

<pre><code class="language-java">package jp.co.baykraft.jmsexample;

import com.sun.messaging.ConnectionConfiguration;
import com.sun.messaging.QueueConnectionFactory;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.MessageListener;
import javax.jms.Queue;
import javax.jms.QueueConnection;
import javax.jms.QueueReceiver;
import javax.jms.QueueSession;
import javax.jms.TextMessage;

/**
 * メッセージを受診するクラスです。
 * @author Katsumi
 */
public class Receiver
{
    public static void main(String... args) throws JMSException
    {
        QueueConnectionFactory factory = new QueueConnectionFactory();
        factory.setProperty(ConnectionConfiguration.imqAddressList, 
            &quot;localhost:7676&quot;);
        QueueConnection connection = factory.createQueueConnection();
        QueueSession session = connection.createQueueSession(false, 
            QueueSession.CLIENT_ACKNOWLEDGE);
        Queue queue = session.createQueue(&quot;KQueue&quot;);

        QueueReceiver receiver = session.createReceiver(queue);
        receiver.setMessageListener(new MessageListener() {
            @Override
            public void onMessage(Message msg)
            {
                try {
                    TextMessage message = (TextMessage) msg;
                    message.acknowledge();
                    System.out.println(message.getText());
                }
                catch (JMSException ex) {
                    Logger.getLogger(Receiver.class.getName())
                          .log(Level.SEVERE, null, ex);
                }
            }
        });

        connection.start();
    }
}
</code></pre>

<h2 id="動かしてみよう">動かしてみよう</h2>

<p>さて、コードも作ったので動かしてみます。
送信するメッセージはキューに溜め込まれるので、コンシューマを起動しておかなくても大丈夫です。
まずはプロデューサーを起動すると、「メッセージ」という文字列がメッセージプロバイダに送られます。</p>

<p>次にコンシューマを起動します。
コンシューマを起動すると、メッセージプロバイダのKQueueに溜め込まれたメッセージが受信されます。
コンシューマのコードの<code>QueueSession.CLIENT_ACKNOWLEDGE</code>の指定ですが、この指定の場合、
コンシューマ側で<code>TextMessage#acknowledge()</code>メソッドを呼び出すまで、キュー上のメッセージは削除されません。
コンシューマ側の処理が失敗した場合はキュー上のメッセージを削除したくないのでこの指定にしています。</p>

<h2 id="まとめ">まとめ</h2>

<p>GlassFishを起動するだけでメッセージプロバイダが起動されるのは非常に便利です。
メッセージプロバイダを起動しておけば、簡単なメッセージの送受信アプリが作れます。
キューの名前をコンシューマ毎に切り替えれば、複数クライアントのアプリも出来そうです。
JMSの本来の利用目的とは違うのかもしれませんが、こんな簡単なアプリから触ってみると楽しいと思います。
それにしても、GlassFishは最高ですね。</p>

      
      
      
    </article>
    
 <aside><div id="disqus_thread"></div></aside>

<script type="text/javascript">
     
    var disqus_shortname = 'katsumikokuzawasblog';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



  </main>
  
  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="https://kokuzawa.github.io/blog/2012/12/11/wiiremotejdeyou-bou-on-osx-10-dot-8-7/" rel="prev">WiiRemoteJで遊ぼう on OSX 10.8.7</a></span>
    
    
      <span class="next"><a href="https://kokuzawa.github.io/blog/2012/12/16/fisheyetocrucible/" rel="next">FishEyeとCrucible #augj</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="/images/avatar.png" width="64" height="64"><br>
      Written by Katsumi Kokuzawa
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-36546771-1', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>

